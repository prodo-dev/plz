version: '2.3'

services:
  all:
    image: docker:stable-git
    command:
      - echo
      - 'Started.'
    depends_on:
      controller:
        condition: service_healthy

  controller:
    image: plztest/controller
    environment:
      CONFIGURATION: |
        port = 80
        data_dir = /data
        redis_host = redis
        results = {
          provider = local
          directory = /data/results
        }
    volumes:
      - ${SECRETS_DIR}/keys/id_rsa:/root/.ssh/id_rsa:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      redis:
        condition: service_started

  redis:
    image: redis:4
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data

volumes:
  redis_data: {}
